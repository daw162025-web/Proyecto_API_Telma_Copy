<div class="container mt-5 mb-5">
  <div class="row">
    <div class="col-12 text-center mb-4">
      <h2 class="fw-bold">Peticiones Activas</h2>
      <p class="text-muted">Ayuda a cambiar el mundo firmando estas causas</p>
    </div>
  </div>

  @if (cargando) {
    <div class="d-flex justify-content-center mt-5">
      <div class="spinner-border text-danger" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
    </div>
  } @else {

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      
      @for (peticion of peticiones; track peticion.id) {
        <div class="col">
          <div class="card h-100 shadow-sm border-0 card-hover">
            
            <div class="position-relative">
               @if(peticion.files && peticion.files.length > 0) {
                 <img [src]="'http://localhost:8000/storage/' + peticion.files[0].file_path" 
                      class="card-img-top" 
                      alt="{{ peticion.titulo }}"
                      style="height: 200px; object-fit: cover;">
               } @else {
                 <img src="assets/imagenes/placeholder.jpg" class="card-img-top" style="height: 200px; object-fit: cover;" alt="Sin imagen">
               }
               
               <span class="badge bg-danger position-absolute top-0 end-0 m-2">
                 {{ peticion.categoria?.nombre || 'General' }}
               </span>
            </div>

            <div class="card-body d-flex flex-column">
              <h5 class="card-title fw-bold text-truncate" title="{{ peticion.titulo }}">
                {{ peticion.titulo }}
              </h5>
              
              <p class="card-text text-muted small flex-grow-1">
                {{ peticion.descripcion.substring(0, 100) }}...
              </p>

              <div class="mt-3">
                <div class="d-flex justify-content-between small fw-bold mb-1">
                  <span>{{ peticion.firmantes || 0 }} firmas</span>
                  <span class="text-danger">Objetivo: 1.000</span> 
                </div>
                <div class="progress" style="height: 6px;">
                  <div class="progress-bar bg-danger" 
                       role="progressbar" 
                       [style.width.%]="((peticion.firmantes || 0) / 1000) * 100" 
                       aria-valuenow="peticion.firmantes" aria-valuemin="0" aria-valuemax="1000">
                  </div>
                </div>
              </div>
            </div>

            <div class="card-footer bg-white border-top-0 pb-3 d-flex justify-content-between align-items-center">
              <a [routerLink]="['/peticiones', peticion.id]" class="btn btn-outline-dark btn-sm rounded-pill px-3">
                Ver más
              </a>

              @if (authService.isLoggedIn()) {
                
                @if (authService.currentUser()?.id === peticion.user_id) {
                  <button (click)="borrar(peticion.id!)" class="btn btn-outline-danger btn-sm rounded-pill" title="Borrar petición">
                    <i class="bi bi-trash"></i>
                  </button>
                } 
                @else {
                  <button (click)="firmar(peticion)" class="btn btn-danger btn-sm rounded-pill px-3 text-white fw-bold">
                    Firmar
                  </button>
                }

              }
            </div>
          </div>
        </div>
      } @empty {
        <div class="col-12 text-center mt-5">
          <div class="alert alert-light" role="alert">
            <h4>No hay peticiones disponibles</h4>
            <p>Sé el primero en crear una.</p>
            @if (authService.isLoggedIn()) {
              <a routerLink="/peticiones/crear" class="btn btn-danger">Crear Petición</a>
            }
          </div>
        </div>
      }

    </div>
  }
</div>