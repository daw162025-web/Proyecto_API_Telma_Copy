<div class="container mt-5 mb-5">
  <div class="row">
    <div class="col-12 text-center mb-4">
      <h2 class="fw-bold">Peticiones Activas</h2>
      <p class="text-muted">Ayuda a cambiar el mundo firmando estas causas</p>
    </div>
  </div>

  @if (authService.loading()) {
    <div class="d-flex justify-content-center mt-5">
      <div class="spinner-border text-danger" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
    </div>
  } @else {

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      
      @for (petition of petitions; track petition.id) {
        <div class="col">
          <div class="card h-100 shadow-sm border-0 card-hover">
            
            <div class="position-relative">
               @if($any(petition).image) {
                 <img [src]="getImage(petition)"
                      class="card-img-top" 
                      alt="{{ petition.title }}"
                      style="height: 200px; object-fit: cover;">
               } @else {
                 <img src="assets/imagenes/placeholder.jpg" 
                      class="card-img-top" 
                      style="height: 200px; object-fit: cover;" 
                      alt="Sin imagen">
               }
               
               <span class="badge bg-danger position-absolute top-0 end-0 m-2">
                 {{ $any(petition).category?.name || 'General' }}
               </span>
            </div>

            <div class="card-body d-flex flex-column">
              <h5 class="card-title fw-bold text-truncate" title="{{ petition.title }}">
                {{ petition.title }}
              </h5>
              
              <p class="card-text text-muted small flex-grow-1">
                {{ petition.description.substring(0, 100) }}...
              </p>

              <div class="mt-3">
                <div class="d-flex justify-content-between small fw-bold mb-1">
                  <span>{{ $any(petition).signeds || 0 }} firmas</span>
                  <span class="text-danger">Objetivo: 1.000</span> 
                </div>
                <div class="progress" style="height: 6px;">
                  <div class="progress-bar bg-danger" 
                       role="progressbar" 
                       [style.width.%]="(($any(petition).signeds || 0) / 1000) * 100" 
                       aria-valuenow="0" aria-valuemin="0" aria-valuemax="1000">
                  </div>
                </div>
              </div>
            </div>

            <div class="card-footer bg-white border-top-0 pb-3 d-flex justify-content-between align-items-center">
              <a [routerLink]="['/petitions', petition.id]" class="btn btn-outline-dark btn-sm rounded-pill px-3">
                Ver más
              </a>

              @if (authService.isLoggedIn()) {
                
                @if (authService.currentUser()?.id === petition.user_id) {
                  <button (click)="delete(petition.id!)" class="btn btn-outline-danger btn-sm rounded-pill" title="Borrar petición">
                    <i class="bi bi-trash"></i>
                  </button>
                } 
                @else {
                  <button (click)="sign(petition)" class="btn btn-danger btn-sm rounded-pill px-3 text-white fw-bold">
                    Firmar
                  </button>
                }

              }
            </div>
          </div>
        </div>
      } @empty {
        <div class="col-12 text-center mt-5">
          <div class="alert alert-light" role="alert">
            <h4>No hay peticiones disponibles</h4>
            <p>Sé el primero en crear una.</p>
            @if (authService.isLoggedIn()) {
              <a routerLink="/petitions/create" class="btn btn-danger">Crear Petición</a>
            }
          </div>
        </div>
      }

    </div>
  }
</div>